Установка ADH в ADCM
====================

Выгрузка бандла ADH в ADCM
---------------------------

Выгрузка бандла **ADH** необходима для создания в **ADCM** прототипа кластера, из которого в дальнейшем становится возможным создание его экземпляров.

Для выгрузки бандла следует выполнить действия аналогичные :doc:`выгрузке бандла хостпровайдера <adcm_upload>`.

Создание экземпляра кластера
-----------------------------

При создании кластера в веб-интерфейсе **ADCM** генерируется новый экземпляр кластера **ADH**, что означает только добавление данных о нем в базу данных **ADCM** -- на этом этапе не производится установка **ADH** на хосты.

1. Открыть в ADCM вкладку *"CLUSTERS"* (:numref:`Рис.%s.<cluster_mon>`).

.. _cluster_mon:

.. figure:: ../imgs/install/cluster_mon.png
   :align: center

   Вкладка "CLUSTERS"

2. Нажать *"Add cluster"* и в открывшейся форме создать экземпляр кластера из прототипа ADH (:numref:`Рис.%s.<add_cluster>`).

.. _add_cluster:

.. figure:: ../imgs/install/add_cluster.png
   :align: center

   Создание экземпляра кластера

3. В результате экземпляр кластера отражается в списке на вкладке *"CLUSTERS"* (:numref:`Рис.%s.<clusters_list>`).

.. _clusters_list:

.. figure:: ../imgs/install/clusters_list.png
   :align: center

   Результат успешного создания экземпляра кластера

Добавление сервисов кластера
------------------------------

.. important:: На текущий момент невозможно удалить из кластера уже добавленный сервис

Для добавления сервисов в кластер **ADH** необходимо (:numref:`Рис.%s.<add_services>`):

1. В меню кластера *ADH* открыть вкладку *"Services"*;

2. Нажать *"Add service"*;

3. В открывшейся форме выбрать необходимые сервисы;

4. Нажать *"Save"*.

.. _add_services:

.. figure:: ../imgs/install/add_services.png
   :align: center

   Выбор сервисов

Возможность добавления нового сервиса в уже работающий кластер не отличается от установки сервиса с нуля.

Конфигурирование сервиса
-------------------------

Для перехода к настройкам сервиса кластера необходимо нажать кнопку с пиктограммой шестеренки в соответствующей строке вкладки пункта меню *"Services"* (:numref:`Рис.%s.<service_configure>`).

.. _service_configure:

.. figure:: ../imgs/install/service_configure.png
   :align: center

   Настройка сервиса

По завершении конфигурирования сервиса необходимо нажать *"Save"*.

В случае, если сервису требуется изначальная настройка, то в поле *"Actions"* соответствующего сервиса вместо иконки отражается оранжевый восклицательный знак (:numref:`Рис.%s.<service_configure_warning>`).

.. _service_configure_warning:

.. figure:: ../imgs/install/service_configure_warning.png
   :align: center

   Сервисы, требующие настройки

Это означает, что необходимо открыть страницу конфигурирования сервиса и заполнить поля, выделенные оранжевым (:numref:`Рис.%s.<service_configure_warning_in>`).

.. _service_configure_warning_in:

.. figure:: ../imgs/install/service_configure_warning_in.png
   :align: center

   Конфигурация сервиса, требующего настройки

.. _add_hosts_chapter:

Добавление хостов
-------------------

Для добавления хостов в кластер **ADH** необходимо:

1. В меню кластера *ADH* открыть вкладку *"Hosts"* (:numref:`Рис.%s.<hosts_list>`).

.. _hosts_list:

.. figure:: ../imgs/install/hosts_list.png
   :align: center

   Вкладка "Hosts" кластера ADH

2. Нажать *"Add hosts"* и в открывшейся форме выбрать необходимые хосты (:numref:`Рис.%s.<add_hosts>`).

.. _add_hosts:

.. figure:: ../imgs/install/add_hosts.png
   :align: center

   Выбор хостов

3. В результате добавленные хосты отображаются в списке вкладки *"Hosts"* (:numref:`Рис.%s.<hosts_list2>`).

.. _hosts_list2:

.. figure:: ../imgs/install/hosts_list2.png
   :align: center

   Результат успешного добавления хостов

.. _install_components:

Размещение компонентов сервисов на хостах
-------------------------------------------

Изначально ни на одном из хостов нет компонентов -- распределение компонентов осуществляется вручную.

Для размещения компонентов необходимо перейти на вкладку *"Hosts - Components"* (:numref:`Рис.%s.<components>`).

.. _components:

.. figure:: ../imgs/install/components.png
   :align: center

   Размещение компонентов сервисов на хостах

И распределить компоненты одним из двух способов:

1. Выбрать компонент в колонке "Components" и определить для него хост в колонке "Hosts";
2. Выбрать хост в колонке "Hosts" и определить для него компонент в колонке "Components".

.. important:: В сервисе могут быть обязательные и необязательные компоненты. Если компонент обязательный, то в его количественном счетчике справа от названия присутствует символ '/'. Без назначения хоста обязательному компоненту карту размещения сервисов нельзя сохранить

По завершении распределения хостов необходимо нажать *"Save"*.

Конфигурирование кластера
----------------------------

Для перехода к настройкам экземпляра кластера **ADH** необходимо нажать кнопку с пиктограммой шестеренки в соответствующей строке вкладки *"CLUSTERS"* и перейти в раздел меню *"Configuration"*. При этом открывается окно конфигурации выбранного экземпляра (:numref:`Рис.%s.<cluster_config>`).

.. _cluster_config:

.. figure:: ../imgs/install/cluster_config.png
   :align: center

   Окно конфигурирования кластера

По завершении конфигурирования кластера необходимо нажать *"Save"*.

.. _install_services:

Установка сервисов кластера
----------------------------

.. important:: Порядок установки сервисов и зависимости между ними на данный момент не ограничивается со стороны ADCM

Устанавливать сервисы необходимо в следующем порядке:

1. Zookeeper

2. HDFS

3. YARN

4. HBase

5. Hive

6. Spark

7. Monitoring

Для установки добавленного сервиса необходимо в строке нужного сервиса нажать на пиктограмму в поле *"Actions"* и выбрать действие *Install*. После этого **ADCM** запускает задачу установки. Более конкретно о статусе и информации о задачах можно узнать на вкладке *"JOBS"* (:numref:`Рис.%s.<jobs>`).

.. _jobs:

.. figure:: ../imgs/install/jobs.png
   :align: center

   Вкладка "JOBS"

.. important:: Статус задач ADCM отражается в правом верхнем углу web-интерфейса. Желтый круг отражает количество запущенных задач, а зеленый и красный -- количество успешно и неуспешно завершенных задач соответственно

Успешное завершение установки сервиса определяется переходом задачи из статуса *running* в статус *success* на вкладке *"JOBS"*. При неудачном завершении задача переходит в статус *failed*. При таком исходе возможно нажать на строку задачи на странице вкладки *"JOBS"* для получения более подробной информации о возникших ошибках (:numref:`Рис.%s.<job>`).

.. _job:

.. figure:: ../imgs/install/job.png
   :align: center

   Страница конкретной задачи

На странице задачи в левой части экрана обязательно содержится 2 раздела: *"№-ansible-out.txt"* и *"№-ansible-out.txt"*, где № является номером задачи. Это технические логи задачи, которые могут помочь в определении причины проблем.

Также может существовать опциональный третий раздел *"№-check-out.json"* -- это логи проверок частых ошибок, описание этих ошибок более простое и конкретное, чем в случае первых двух технических логов.

Содержимое всех трех разделов подлежит изучению при возникновении ошибок.

После установки сервис запускается автоматически, кроме сервиса *Zookeeper* -- его требуется запустить вручную нажатием кнопки *"Start"*.

.. important:: Сервис Zookeeper требует ручного запуска

По результатам инсталляции сервис меняет состояние (поле *"State"*) с *created* на *installed* (:numref:`Рис.%s.<cluster_actions>`).

.. _cluster_actions:

.. figure:: ../imgs/install/cluster_actions.png
   :align: center

   Состояние сервисов кластера

Особенности установки сервисов
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Hive
******

Компонент *Metastore* сервиса *Hive* требует наличия БД *MySQL/MariaDB* и доступов к ней.

Сервис *MySQL/MariaDB* в бандл **ADH** не входит, его необходимо устанавливать и настраивать другими средствами.

.. important:: Помимо настройки самого сервиса MySQL/MariaDB для использования его сервисом Hive необходимо также настроить соответствующие доступы (GRANT)

Так, самый простой случай выдачи доступов выглядит следующим образом:

.. code-block:: shell

   MariaDB [(none)]> GRANT ALL ON *.* TO 'root'@'<metastore_fqdn>' identified by '<password>' WITH GRANT OPTION;

Где ``<metastore_fqdn>`` и ``<password>`` необходимо заменить реальными данными конкретного сервера *MySQL/MariaDB*.

Указать сервису *Hive* адрес и учетные данные для подключения к БД можно в `настройках сервиса <Конфигурирование сервиса_>`_.

Monitoring
***********

Сервис *Monitoring* кластера **ADH** требует `установки отдельного кластера Monitoring <https://docs.arenadata.io/mon/ru/index.html>`_ для целей интеграции в него кластера **ADH**.

После установки кластера *Monitoring* его необходимо интегрировать в кластер **ADH**. Для этого необходимо перейти в раздел меню *"Import"* кластера **ADH** (:numref:`Рис.%s.<import>`).

.. _import:

.. figure:: ../imgs/install/import.png
   :align: center

   Раздел меню "Import"

Далее необходимо отметить флагами оба импортируемых сервиса кластера *Monitoring*: *Graphite* и *Grafana*, и нажать *"Save"* в верхней правой части страницы.

После интеграции сервису *Monitoring* кластера **ADH** становятся доступными средства для мониторинга некоторых сервисов кластера:

- HDFS;

- YARN;

- HBase;

- Spark.

Для использования этих средств необходимо установить сервис, предназначенный для мониторинга, и сервис *Monitoring* кластера **ADH**.

.. important:: В случае, если сервис Monitoring установлен после сервиса, предназначенного для мониторинга, необходим рестарт этого сервиса
